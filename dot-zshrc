# Minimal, fast defaults
export ZDOTDIR="$HOME"
export HISTFILE="$HOME/.zsh_history"
export SAVEHIST=5000
export HISTSIZE=5000

# Core options early (before plugins, so they apply)
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt SHARE_HISTORY
setopt AUTO_CD
setopt CORRECT
setopt CORRECT_ALL  # Standard: Suggests corrections for entire command line (e.g., multi-word)
setopt EXTENDED_GLOB  # Standard: Enables advanced glob patterns (e.g., git rm (*~cache|*.log))

# zplug setup (assume installed via dotfiles script; no interactive prompt here)
if [[ -f ~/.zplug/init.zsh ]]; then
    source ~/.zplug/init.zsh

    # Plugins (load completions last)
    zplug "zsh-users/zsh-autosuggestions"
    zplug "zsh-users/zsh-syntax-highlighting"
    zplug "zsh-users/zsh-history-substring-search"
    zplug "zsh-users/zsh-completions", use:"zsh-completions.plugin.zsh"

    # Check and load (non-interactive: install only if explicitly run elsewhere)
    if ! zplug check --verbose; then
        # Silent fail in zshrc—handle install in dotfiles script
        zplug load --verbose || true
    else
        zplug load
    fi
else
    # Fallback if zplug missing (rare, post-curl)
    echo "zplug not found—run install script" >&2
fi

# History substring search bindings (essential for prefix/substring up/down)
if zplug check "zsh-users/zsh-history-substring-search"; then
    bindkey '^[[A' history-substring-search-up      # Up: substring search backward
    bindkey '^[[B' history-substring-search-down    # Down: forward
    # Optional: Highlight matches (low overhead)
    HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND='bg=magenta,fg=white,bold'
    HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND='bg=red'
fi

# Prompt
# Starship prompt (guard if missing)
if command -v starship >/dev/null 2>&1; then
  export STARSHIP_CONFIG="$HOME/.config/starship.toml"
  eval "$(starship init zsh)"
fi

# Set default directory to app folder (only if starting from home)
if [ "$PWD" = "$HOME" ]; then
    mkdir -p ~/app
    cd ~/app
fi

# asdf env for non-login zsh
[[ -f /etc/profile.d/asdf.sh ]] && . /etc/profile.d/asdf.sh

# Enable zsh completions (after zplug, to include plugin comps)
autoload -Uz compinit && compinit -i

# Case-insensitive, approx fuzzy matching (standard for devs—speeds tab-complete for misspells)
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

# For UV Python
export PATH="$HOME/.local/bin:$PATH"

# Common aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# Git aliases
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline'
alias gd='git diff'
alias lg='git lg'
alias gundo='git reset --soft HEAD~1'

# Phoenix development aliases
alias phx="mix phx.server"
alias phxd="MIX_ENV=dev mix phx.server"
alias phxt="MIX_ENV=test mix test"
alias ecto="mix ecto"
alias iex="iex -S mix"

# Database shortcuts
alias db.create="mix ecto.create"
alias db.migrate="mix ecto.migrate"
alias db.reset="mix ecto.reset"
alias db.seed="mix ecto.seed"